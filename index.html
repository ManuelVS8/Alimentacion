<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Los animales se alimentan</title>
<link rel="icon" href="https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/icono.ico" type="image/x-icon">
<style>
  /* ====== Reset & base ====== */
  * { box-sizing: border-box; margin:0; padding:0; }
  :root{
    --blue:#001DFF;
    --blue-dark:#04032B;
    --blue-700:#1a3a5f;
    --blue-600:#254fba;
    --orange:#f59e42;
    --orange-700:#e67e22;
    --bg-grad-1:#1a3a5f;
    --bg-grad-2:#0d2340;
    --white:#ffffff;
    --green:#2ecc71;
    --red:#e74c3c;
    --panel:#E8EAFF;
  }
  body{
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
    min-height:100vh; display:flex; justify-content:center; align-items:center; color:#333; padding:10px;
  }
  .game-container{
    background:var(--white); border-radius:16px; box-shadow:0 12px 24px rgba(0,0,0,.12);
    padding:1.2rem; max-width:980px; width:100%; min-height:640px; position:relative; overflow:hidden;
    display:flex; flex-direction:column;
  }
  header{ text-align:center; margin-bottom:.8rem; margin-top:2rem; }
  h1{ color:var(--blue-dark); font-size:clamp(2rem,5.2vw,3.1rem); font-weight:900; letter-spacing:.5px; }
  .subtitle{ color:var(--blue-700); font-size:clamp(1rem,3.5vw,1.25rem); margin-top:.25rem; }
  .highlight-keyword{ color:var(--orange); font-weight:800; }

  .btn{ color:#fff; border:none; padding:.75rem 1.2rem; border-radius:10px; cursor:pointer; font-weight:800;
        transition:transform .08s ease, box-shadow .2s ease, background-color .25s ease; min-width:140px; height:48px;
        display:inline-flex; align-items:center; justify-content:center; }
  .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.12); }
  .btn:active{ transform:translateY(0); }
  .btn-primary{ background:var(--orange); }
  .btn-primary:hover{ background:var(--orange-700); }
  .btn-blue{ background:var(--blue-600); }
  .btn-blue:hover{ filter:brightness(.9); }
  .btn-ghost{ background:#e6f2ff; color:var(--blue-700); }

  .screen{ display:none; animation:fadeIn .35s ease; }
  .screen.active{ display:block; }
  @keyframes fadeIn{ from{opacity:0; transform:translateY(12px);} to{opacity:1; transform:translateY(0);} }

  .game-info{ display:flex; gap:.6rem; align-items:center; justify-content:space-between; margin:.4rem 0 1rem; flex-wrap:wrap; }
  .timer{ font-weight:900; color:var(--blue-700); font-size:clamp(.95rem,2.3vw,1.15rem); }
  .progress-bar{ flex:1; height:10px; background:#e6f2ff; border-radius:999px; overflow:hidden; }
  .progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--orange) 0%, var(--orange-700) 100%); transition:width .3s ease; }
  .score{ font-weight:900; color:var(--blue-700); font-size:clamp(.9rem,2.3vw,1.1rem); }

  .start-content{ display:flex; flex-direction:column; justify-content:center; align-items:center; flex:1; gap:1rem; padding:1rem; }
  .advice-box{ background:var(--panel); border-left:4px solid var(--blue-700); padding:1rem 1.2rem; border-radius:12px;
               color:var(--blue-700); max-width:760px; text-align:center; font-size:clamp(1rem,3vw,1.15rem); }
  .start-image{ max-width: 300px; width: 100%; margin: 0 auto; }
  .advice-box .advice-text { display: block; }
  .advice-box strong { display: block; margin-top: 0.5rem; text-align: center; }

  .mute-btn{ position:absolute; top:.8rem; right:4.5rem; background:var(--orange); color:#fff; border:2px solid #fff; width:38px; height:38px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; z-index:20; }
  .mute-btn:hover{ background:var(--orange-700); }
  .help-btn{ position:absolute; top:.8rem; right:.8rem; width:38px; height:38px; border-radius:50%; border:none; background:#9c27b0; color:#fff; font-weight:800; cursor:pointer; z-index:20; }

  .board{ display:grid; grid-template-columns:1fr; gap:.8rem; align-items:start; }
  .panel{ background:#f8fbff; border:2px solid #d3e2ff; border-radius:12px; padding:.7rem .9rem; display:flex; align-items:center; justify-content:space-between; gap:.8rem; }
  .word-display-container{ display:flex; align-items:center; justify-content:center; gap:0.5rem; flex:1; }
  .word-display{ font-size:clamp(1.2rem,4.5vw,1.8rem); font-weight:900; color:var(--blue-700); text-align:center; }
  .btn-play-word{ background:var(--blue-600); color:#fff; border:none; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background-color .2s; }
  .btn-play-word:hover{ background:var(--blue-700); }
  .btn-play-word svg{ width:20px; height:20px; }
  .group-name{ margin-left: 10px; color: var(--blue-700); font-weight: 600; }

  .stage{ background:#fff; border-radius:12px; border:2px solid #e6f2ff; padding:.6rem; box-shadow: inset 0 0 0 1px #f3f7ff; }
  .img-wrap{ position:relative; width:100%; max-width:680px; margin:0 auto; }
  .img-wrap img{ display:block; width:100%; height:auto; border-radius:10px; user-select:none; -webkit-user-drag:none; }

  /* Estilos del marcador (cuadro de selecci√≥n) */
  .marker{
      position:absolute;
      background:rgba(255, 255, 255, 0); 
      border:2px solid transparent; /* Inicialmente transparente */
      border-radius:0;
      box-shadow:none;
      transform:translate(0, 0); 
      display:flex; align-items:center; justify-content:center; pointer-events:auto;
      cursor: pointer;
  }
  /* Estilo para correcta (se mantiene) */
  .marker.correct{ border-color:#20b86a; background:rgba(32, 184, 106, 0.2); } 
  /* Estilo para incorrecta (parpadea) */
  .marker.reveal-red{ border-color:#e74c3c; background:rgba(231, 76, 60, 0.2); } 
  .overlay-click{ position:absolute; inset:0; }

  .results{ display:flex; flex-direction:column; align-items:center; gap:.6rem; text-align:center; min-height:calc(100vh - 180px); }
  .final-title{ color:var(--blue-dark); font-weight:900; }
  .big-score{ font-size:clamp(2.2rem,6vw,3.4rem); color:var(--blue-600); font-weight:900; }
  .score-title{ font-size:1.0rem; color:var(--blue-700); margin-top:1rem; }
  .final-time{ color:var(--blue-700); }
  .trophy{ font-size:clamp(4rem,10vw,6rem); margin:.2rem 0; color:var(--orange); animation:bounce 1s ease infinite; }
  @keyframes bounce { 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-8px);} }
  .credit{ color:var(--blue-700); margin-top:1rem; }
  #finalMsg { font-size: clamp(1.6rem, 3.8vw, 2.4rem); font-weight: 800; color: var(--blue-700); margin-top: 0.6rem; }
  .school-logo { display: block; width: 160px; max-width: 28%; height: auto; margin-top: 0.8rem; border-radius: 8px; object-fit: contain; }

  /* Ajustes responsivos */
  @media (min-width:900px){ .board{ grid-template-columns: 360px 1fr; align-items:start; } .panel{ order:1; } .stage{ order:2; } }
  @media (max-width:899px){
    header{ margin-top:1.6rem; }
    .board{ grid-template-columns:1fr; }
    .panel{ display:flex; flex-direction:row; align-items:center; justify-content:space-between; padding:.6rem; }
    .word-display-container{ order:0; width:100%; margin-bottom:.6rem; }
    .stage{ order:1; }
  }
  @media (max-width:420px){ 
    .btn{ min-width:110px; padding:.6rem .9rem; height:44px; } 
    .school-logo { width: 110px; max-width: 40%; margin-top: 0.6rem; }
    .results { gap: 0.4rem; padding: 0 0.6rem; }
    #finalMsg { font-size: clamp(1.2rem, 4.2vw, 1.8rem); }
    .big-score { font-size: clamp(1.8rem, 6vw, 2.6rem); }
  }
  
  .confetti{ position:fixed; width:10px; height:10px; border-radius:50%; animation: confetti-fall 3s linear forwards; z-index:999; }
  @keyframes confetti-fall{ 0%{ transform:translate(0, -20px) rotate(0); opacity:1;} 100%{ transform:translate(var(--tx), var(--ty)) rotate(360deg); opacity:0; } }

  .loading-indicator {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7); display: none; justify-content: center;
    align-items: center; z-index: 1000; flex-direction: column;
  }
  .loading-spinner {
    width: 50px; height: 50px; border: 5px solid #f3f3f3;
    border-top: 5px solid var(--orange); border-radius: 50%;
    animation: spin 1s linear infinite; margin-bottom: 20px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading-text { color: white; font-size: 1.2rem; text-align: center; }
  
  /* Ocultar elementos de navegaci√≥n de palabra, no son necesarios en este modo */
  .arrow-wrap.hidden { display: none; }
  .word-display-container.audio-only .word-display { display: none; }
</style>
</head>
<body>
<div class="game-container">
  <button class="mute-btn" id="muteBtn" title="Silenciar/Activar sonido">üîä</button>

  <section class="screen active" id="startScreen" aria-labelledby="title">
    <header>
      <h1 id="title">Los animales se alimentan</h1>
      <div class="subtitle">Indica si los siguientes animales son carn√≠voros, herb√≠voros u omn√≠voros.</div>
    </header>
    <div class="start-content">
      <div class="advice-box" role="note" aria-live="polite">
        <span class="advice-text">
            <span class="highlight-keyword">Recuerda</span>: los animales que se alimenta de otros animales son <span class="highlight-keyword">carn√≠voros</span>; los que se alimentan de plantas son <span class="highlight-keyword">herb√≠voros</span> y los que se alimentan de otros animales y de plantas son <span class="highlight-keyword">omn√≠voros</span>.
        </span>
        <strong>¬°√Ånimo!</strong>
      </div>
      <button class="btn btn-primary" id="playBtn">Comenzar</button>
      <img class="start-image" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Ni%C3%B1os.png" alt="Ni√±os aprendiendo">
    </div>
  </section>

  <section class="screen" id="gameScreen">
    <button class="help-btn" id="helpBtn" title="Ayuda">?</button>
    <header>
      <h1>¬øC√≥mo se alimentan los animales?</h1>
      <div class="subtitle">Escucha y se√±ala los animales seg√∫n su alimentaci√≥n</div>
    </header>
    <div class="game-info">
      <div class="timer" id="timer">00:00</div>
      <div class="progress-bar" aria-label="Progreso"><div class="progress-fill" id="progressFill"></div></div>
      <div class="score">Puntuaci√≥n: <span id="score">0</span></div>
    </div>

    <div class="board">
      <div class="panel" aria-live="polite">
        <div class="arrow-wrap hidden" id="prevPairWrap"></div>
        <div class="word-display-container audio-only" id="wordDisplayContainer">
          <div class="word-display" id="wordDisplay">‚Äî</div>
          <button class="btn-play-word" id="playWordBtn" title="Reproducir audio" aria-label="Reproducir audio">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5v14l11-7z" fill="currentColor"/>
            </svg>
          </button>
          <div class="group-name" id="groupName" style="margin-left: 10px; color: var(--blue-700); font-weight: 600;"></div>
        </div>
        <div class="arrow-wrap hidden" id="nextPairWrap"></div>
      </div>

      <div class="stage">
        <div class="img-wrap" id="imgWrap">
          <img id="bodyImg" src="https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Vivos_Inertes/alimentacion/Alimentacion.png" alt="Animales para identificar su alimentaci√≥n">
          <div class="overlay-click" id="overlayClick" aria-hidden="true"></div>
        </div>
        <div class="startGameArea"></div>
      </div>
    </div>
  </section>

  <section class="screen" id="resultsScreen">
    <header>
      <h1 class="final-title">Animales carn√≠voros, herb√≠voros y omn√≠voros</h1>
    </header>
    <div class="results">
      <div id="trophyBox" style="display:none;">
        <div class="trophy">üèÜ</div>
      </div>
      <div class="score-title">Puntuaci√≥n:</div>
      <div class="big-score" id="finalScore">0</div>
      <div class="final-time">Tiempo: <span id="finalTime">00:00</span></div>
      <div id="finalMsg" class="subtitle"></div>
      <button class="btn btn-primary" id="backToMenuBtn">Volver al men√∫</button>
      <span class="credit">Creado por Manuel J. Ventura</span>
      <img class="school-logo" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Siurot.png" alt="Logo del colegio" />
    </div>
  </section>
</div>

<div class="loading-indicator" id="loadingIndicator">
  <div class="loading-spinner"></div>
  <div class="loading-text">Cargando audios y efectos...</div>
</div>

<div id="helpModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:100; justify-content:center; align-items:center; padding:1rem;">
  <div style="background:#fff; border-radius:12px; max-width:680px; width:100%; padding:1.2rem 1.2rem; box-shadow:0 10px 24px rgba(0,0,0,.2);">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:.5rem; margin-bottom:.8rem;">
      <h3 style="color:var(--blue-700);">C√≥mo jugar</h3>
      <button class="btn-ghost" id="closeHelp" style="border-radius:8px; padding:.4rem .7rem; height:auto; min-width:auto;">Cerrar</button>
    </div>
    <div style="line-height:1.55; color:#333;">
      <p><strong style="color: #001A73; font-weight: bold;">Pulsa el bot√≥n del reproductor</strong> para escuchar el tipo de animal que debes encontrar y <strong style="color: #001A73; font-weight: bold;">selecciona los 4</strong> animales de ese grupo en la imagen.</p>
    </div>
  </div>
</div>

<script>
/************** Data **************/
const ORIGINAL_W = 752, ORIGINAL_H = 673; // M√°ximo de coordenadas

// Base de los audios de los sistemas
const GITHUB_BASE = 'https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/main/Vivos_Inertes/alimentacion/';
const GITHUB_EFFECTS_REPO = 'ManuelVS8/Efectos_audio';
// URL para los efectos (usando CDN para mayor compatibilidad)
const CDN_URL = (repo, path) => `https://cdn.jsdelivr.net/gh/${repo}@main/${path}`; 

/* Datos de los sistemas (4 por grupo) */
const PAIRS = [
  // Carn√≠voros (Carnivorous) - Grupo 1
  {x1:14, y1:13, x2:198, y2:233, word:'Carn√≠voro', audio: GITHUB_BASE + 'carnivoro.mp3'}, // 1
  {x1:568, y1:233, x2:752, y2:453, word:'Carn√≠voro', audio: GITHUB_BASE + 'carnivoro.mp3'}, // 2
  {x1:384, y1:452, x2:568, y2:673, word:'Carn√≠voro', audio: GITHUB_BASE + 'carnivoro.mp3'}, // 3
  {x1:15, y1:453, x2:198, y2:672, word:'Carn√≠voro', audio: GITHUB_BASE + 'carnivoro.mp3'}, // 4
  
  // Herb√≠voros (Herbivorous) - Grupo 2
  {x1:198, y1:14, x2:382, y2:232, word:'Herb√≠voro', audio: GITHUB_BASE + 'herbivoros.mp3'}, // 5
  {x1:567, y1:13, x2:750, y2:231, word:'Herb√≠voro', audio: GITHUB_BASE + 'herbivoros.mp3'}, // 6
  {x1:197, y1:233, x2:382, y2:452, word:'Herb√≠voro', audio: GITHUB_BASE + 'herbivoros.mp3'}, // 7
  {x1:568, y1:453, x2:752, y2:673, word:'Herb√≠voro', audio: GITHUB_BASE + 'herbivoros.mp3'}, // 8
  
  // Omn√≠voros (Omnivorous) - Grupo 3
  {x1:383, y1:13, x2:567, y2:232, word:'Omn√≠voro', audio: GITHUB_BASE + 'omnivoro.mp3'}, // 9
  {x1:14, y1:233, x2:197, y2:452, word:'Omn√≠voro', audio: GITHUB_BASE + 'omnivoro.mp3'}, // 10
  {x1:384, y1:232, x2:567, y2:452, word:'Omn√≠voro', audio: GITHUB_BASE + 'omnivoro.mp3'}, // 11
  {x1:198, y1:452, x2:381, y2:671, word:'Omn√≠voro', audio: GITHUB_BASE + 'omnivoro.mp3'} // 12
];

// Audio files for effects. NOTE: Using direct raw URLs for robust implementation.
const soundFiles = {
  completed: 'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/main/Completado.mp3', // Usamos main para simplificar
  correct:   'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/main/Correcto.mp3',
  victory:   'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/main/Termin√©.mp3',
  error:     'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/main/Error.mp3',
  tap:       'https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/main/Tap.mp3'
};
const sounds = {};
let isMuted = false;
let audioUnlocked = false; 
let currentWordAudio = null;
let pendingAudioTimeout = null;
let audiosPrecargados = false;
let userInteracted = false;

/* Inicializaci√≥n de audios de efectos */
Object.entries(soundFiles).forEach(([k, url])=>{
  const a = new Audio();
  a.src = url;
  a.preload = 'auto';
  a.crossOrigin = 'anonymous'; 
  sounds[k] = a;
});

const wordAudios = {};

/**
 * Precarga los audios con un fallback de timeout para evitar bloqueos por 'canplaythrough' fallido.
 */
function preloadWordAudios() {
  return new Promise((resolve) => {
    const uniquePairs = PAIRS.filter((pair, index, self) => 
        index === self.findIndex((t) => (t.word === pair.word))
    );
    
    let loadedCount = 0;
    const totalToLoad = uniquePairs.length;

    if (totalToLoad === 0) {
      audiosPrecargados = true;
      resolve();
      return;
    }

    uniquePairs.forEach((pair) => {
      try {
        const audio = new Audio();
        audio.src = pair.audio;
        audio.preload = 'auto';
        audio.crossOrigin = 'anonymous';

        const checkCompletion = () => {
           if (audio.dataset.loaded) return; 
           audio.dataset.loaded = true;

           loadedCount++;
           if (loadedCount === totalToLoad) {
             audiosPrecargados = true;
             resolve();
           }
        };

        audio.addEventListener('canplaythrough', checkCompletion, { once: true });
        audio.addEventListener('loadedmetadata', checkCompletion, { once: true });
        audio.addEventListener('error', checkCompletion, { once: true });
        audio.load();
        wordAudios[pair.word] = audio;

        // Fallback: Si no se dispara despu√©s de 4 segundos, asumimos cargado.
        setTimeout(() => {
          if (!audio.dataset.loaded) {
            console.warn(`Timeout: Audio "${pair.word}" failed to fire load event. Assuming loaded.`);
            checkCompletion();
          }
        }, 4000);

      } catch(e) {
        loadedCount++;
        if (loadedCount === totalToLoad) {
          audiosPrecargados = true;
          resolve();
        }
      }
    });
  });
}

/**
 * Intenta desbloquear el Web Audio API
 */
function unlockAudio(){
  if (audioUnlocked) return;
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g);
    g.connect(ctx.destination);
    g.gain.value = 0.0001;
    o.start();
    o.stop(ctx.currentTime + 0.02);
    audioUnlocked = true;
  } catch(e){
    audioUnlocked = true;
  }
}

function play(name){
  if(isMuted) return;
  const a = sounds[name];
  if(!a) return;
  try{
    a.currentTime = 0;
    const p = a.play();
    if (p && p.catch) p.catch(() => {});
  } catch(e){}
}

function reproducirSonidoCorrecto(){ play('correct'); }
function reproducirSonidoError(){ play('error'); }
function reproducirSonidoCompletado(){ play('completed'); }
function reproducirSonidoVictoria(){ play('victory'); }
function reproducirSonidoTap(){ play('tap'); }

/**
 * Reproduce el audio de la palabra con l√≥gica robusta de carga.
 */
function playWordAudio(word, delay = 0) {
  if (!userInteracted || isMuted) return;

  if (pendingAudioTimeout) {
    clearTimeout(pendingAudioTimeout);
    pendingAudioTimeout = null;
  }

  const audio = wordAudios[word];
  if (!audio) return;
  
  if (currentWordAudio && !currentWordAudio.paused && currentWordAudio !== audio) {
    currentWordAudio.pause();
    currentWordAudio.currentTime = 0;
  }
  currentWordAudio = audio;

  const playAudioNow = () => {
    try {
      if (audio.readyState < 2) { 
        audio.load();
      }

      audio.currentTime = 0;
      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise.catch((e) => {
          console.error("Fallo al reproducir audio:", e);
        });
      }
    } catch(e) {}
  };

  if (delay > 0) {
    pendingAudioTimeout = setTimeout(playAudioNow, delay);
  } else {
    playAudioNow();
  }
}

/************** State & helpers **************/
const el = (id)=>document.getElementById(id);
const bodyImg = el('bodyImg');
const imgWrap = el('imgWrap');
const wordDisplay = el('wordDisplay');
const playWordBtn = el('playWordBtn');
const groupName = el('groupName');
const progressFill = el('progressFill');
const timerEl = el('timer');
const scoreEl = el('score');
const loadingIndicator = el('loadingIndicator');

let playOrder = [];
let correctCount = 0;
let timerInt = null; let elapsed = 0;
let markers = [];
let mode = 'play';
let currentGroup = '';
const ANSWERS_PER_GROUP = 4;
let correctSelectionsInGroup = 0;
let totalAnswers = 0; // Para la puntuaci√≥n final
let selectedMarkerIndices = new Set(); // Almacena los √≠ndices de los marcadores seleccionados para el grupo actual

function fmtTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
function startTimer(){ clearInterval(timerInt); timerInt = setInterval(()=>{ elapsed++; timerEl.textContent = fmtTime(elapsed); },1000); }
function stopTimer(){ clearInterval(timerInt); }

function updateProgress(){ 
  const totalGroups = 3;
  const currentGroupIndex = playOrder.indexOf(currentGroup);
  const completedGroups = currentGroupIndex === -1 ? totalGroups : currentGroupIndex; 
  
  const pct = (completedGroups / totalGroups) * 100;
  
  progressFill.style.width = pct + '%'; 
  
  // Puntuaci√≥n: 12 √∑ total de respuestas realizadas √ó 100. M√°ximo 12/12*100 = 100
  const score = totalAnswers > 0 ? Math.round((12 / totalAnswers) * 100) : 0;
  scoreEl.textContent = score; 
}

function calculateFinalScore(){ 
  return totalAnswers > 0 ? Math.round((12 / totalAnswers) * 100) : 0;
}

function placeMarkers(){
  markers.forEach(m=>m.remove()); markers = [];
  const rect = bodyImg.getBoundingClientRect();
  const scaleX = rect.width / ORIGINAL_W;
  const scaleY = rect.height / ORIGINAL_H;

  PAIRS.forEach((p, idx)=>{
    // Coordenadas superiores izquierdas (x1, y1)
    const x = p.x1 * scaleX;
    const y = p.y1 * scaleY;
    // Coordenadas de ancho y alto
    const w = (p.x2 - p.x1) * scaleX;
    const h = (p.y2 - p.y1) * scaleY;

    const div = document.createElement('div');
    div.className = 'marker';
    div.style.left = x + 'px';
    div.style.top  = y + 'px';
    div.style.width = w + 'px';
    div.style.height = h + 'px';
    div.dataset.idx = idx;
    div.tabIndex = 0;
    div.setAttribute('role','button');
    div.setAttribute('aria-label', `Cuadro de selecci√≥n para ${p.word}`);
    div.addEventListener('click', onMarkerClick);
    div.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); onMarkerClick.call(div, e); }});
    imgWrap.appendChild(div); markers.push(div);
  });
}

function refreshMarkersStyles(){
  const rect = bodyImg.getBoundingClientRect();
  const scaleX = rect.width / ORIGINAL_W;
  const scaleY = rect.height / ORIGINAL_H;

  markers.forEach((div)=>{
    const idx = +div.dataset.idx; const p = PAIRS[idx];
    div.style.left = (p.x1*scaleX) + 'px';
    div.style.top  = (p.y1*scaleY) + 'px';
    div.style.width = ((p.x2 - p.x1)*scaleX) + 'px';
    div.style.height = ((p.y2 - p.y1)*scaleY) + 'px';
  });
}

function setWordDisplayByGroup(group){
  if (!group) return;
  
  // Buscar un √≠ndice del grupo (solo para obtener el audio/nombre)
  const firstIndex = PAIRS.findIndex(p => p.word === group);
  const pair = PAIRS[firstIndex];
  if(!pair) return;
  
  wordDisplay.textContent = group;
  groupName.textContent = group;
  
  // Retardo de 500ms para el audio autom√°tico
  playWordAudio(group, 500); 
}

function beginPlay(){
  mode='play';
  // Obtener grupos √∫nicos y mezclarlos
  const uniqueGroups = [...new Set(PAIRS.map(p => p.word))];
  playOrder = shuffle(uniqueGroups);
  
  correctSelectionsInGroup = 0;
  totalAnswers = 0;
  selectedMarkerIndices.clear(); 
  updateProgress();
  markers.forEach(m=> m.classList.remove('correct','reveal-red'));
  
  const firstGroup = playOrder[0];
  currentGroup = firstGroup;
  setWordDisplayByGroup(firstGroup);

  elapsed = 0;
  timerEl.textContent = '00:00';
  startTimer();
}

function onMarkerClick(e){
  if(mode!=='play') return;
  trackUserInteraction(); 
  
  const idxClicked = +this.dataset.idx;
  const currentPair = PAIRS[idxClicked];
  
  // 1. Verificar si ya se ha seleccionado este marcador para el grupo actual
  if(selectedMarkerIndices.has(idxClicked)) {
    return; // Ignorar si ya fue seleccionado para este grupo
  }
  
  if(currentPair.word !== currentGroup) {
    // 2. Selecci√≥n incorrecta
    this.classList.add('reveal-red');
    setTimeout(()=> this.classList.remove('reveal-red'), 200);
    reproducirSonidoError();
    totalAnswers++;
    updateProgress();
    return;
  }

  // 3. Selecci√≥n correcta
  this.classList.add('correct');
  reproducirSonidoCorrecto();
  correctSelectionsInGroup++;
  totalAnswers++;
  selectedMarkerIndices.add(idxClicked); // A√±adir a los marcadores seleccionados
  updateProgress();

  // 4. Verificar si se han seleccionado las 4 correctas
  if(correctSelectionsInGroup === ANSWERS_PER_GROUP) {
    // Completado el grupo
    const nextGroupIndexInOrder = playOrder.indexOf(currentGroup) + 1;
    
    setTimeout(() => {
      // Resetear para el siguiente grupo (deseleccionar los marcadores verdes)
      markers.forEach(m => m.classList.remove('correct'));

      correctSelectionsInGroup = 0;
      selectedMarkerIndices.clear(); // Limpiar los marcadores seleccionados para el nuevo grupo
      
      // 5. Pasar al siguiente grupo o finalizar
      if(nextGroupIndexInOrder < playOrder.length) {
        currentGroup = playOrder[nextGroupIndexInOrder];
        setWordDisplayByGroup(currentGroup);
      } else {
        // Juego completado
        currentGroup = null; // Marcar como finalizado
        finishGame();
      }
    }, 500);
  }
}

function finishGame(){ 
  stopTimer(); 
  const score = calculateFinalScore();
  el('gameScreen').classList.remove('active'); 
  el('resultsScreen').classList.add('active');
  el('finalScore').textContent = score; 
  el('finalTime').textContent = fmtTime(elapsed);
  el('trophyBox').style.display = (score===100) ? 'block' : 'none';
  const msg = (score===100) ? '¬°Enhorabuena, puntuaci√≥n m√°xima!' : '¬°Buen trabajo! Sigue practicando';
  el('finalMsg').textContent = msg;
  if(score===100){ 
    reproducirSonidoVictoria(); 
    spawnConfetti(); 
  } else { 
    reproducirSonidoCompletado(); 
  }
  updateProgress(); // Asegurar que la barra de progreso est√© al 100%
}

function shuffle(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

function spawnConfetti(){
  for(let i=0;i<120;i++){
    setTimeout(()=>{
      const c=document.createElement('div');
      c.className='confetti';
      const x=Math.random()*window.innerWidth;
      const ty=window.innerHeight+20;
      const tx=(Math.random()-.5)*160;
      const colors=['#ff595e','#1982c4','#6a4c93','#ffca3a','#8ac926','#ff924c','#00c2ff'];
      c.style.left=x+'px';
      c.style.top='-10px';
      c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
      const size=6+Math.random()*8;
      c.style.width=size+'px';
      c.style.height=size+'px';
      c.style.setProperty('--tx', tx+'px');
      c.style.setProperty('--ty', ty+'px');
      document.body.appendChild(c);
      setTimeout(()=>c.remove(), 3200);
    }, i*18);
  }
}

function gotoStart(){
  el('resultsScreen').classList.remove('active'); 
  el('gameScreen').classList.remove('active'); 
  el('startScreen').classList.add('active');
  playOrder=[]; 
  correctCount=0; 
  elapsed=0; 
  timerEl.textContent='00:00'; 
  progressFill.style.width='0%'; 
  scoreEl.textContent='0'; 
  mode='play';
  markers.forEach(m=> m.classList.remove('correct','reveal-red'));
  userInteracted = false;
  if (currentWordAudio) { currentWordAudio.pause(); currentWordAudio.currentTime = 0; currentWordAudio = null; }
  if (pendingAudioTimeout) { clearTimeout(pendingAudioTimeout); pendingAudioTimeout = null; }
}

/**
 * Funci√≥n CLAVE para desbloquear el audio tras la primera interacci√≥n del usuario.
 */
function trackUserInteraction() {
  if (!userInteracted) {
    userInteracted = true;
    unlockAudio();

    // Forzar la activaci√≥n del primer elemento Audio del juego (cualquiera)
    const firstAudioKey = Object.keys(wordAudios)[0];
    if (firstAudioKey && wordAudios[firstAudioKey]) {
        try {
            const audio = wordAudios[firstAudioKey];
            audio.volume = 0; // Silenciar la activaci√≥n
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    audio.pause();
                    audio.volume = 1; // Restaurar volumen
                    audio.currentTime = 0;
                }).catch((e) => {
                    audio.volume = 1; 
                });
            }
        } catch(e) {}
    }
    
    if (audiosPrecargados) {
        loadingIndicator.style.display = 'none';
    }
  }
  // Remove listeners after first interaction
  document.removeEventListener('click', trackUserInteraction, { once: false });
  document.removeEventListener('touchstart', trackUserInteraction, { once: false });
  document.removeEventListener('keydown', trackUserInteraction, { once: false });
}

/* --- Inicializaci√≥n --- */
document.addEventListener('DOMContentLoaded', async () => {
    loadingIndicator.style.display = 'flex';
    loadingIndicator.querySelector('.loading-text').textContent = "Cargando audios y efectos...";
    
    // Iniciar precarga
    const preloadPromise = preloadWordAudios(); 

    // Solo mostrar el indicador si la carga tarda m√°s de 100ms
    const timer = setTimeout(() => {
        if (!audiosPrecargados) {
            loadingIndicator.style.display = 'flex';
        }
    }, 100);

    await preloadPromise; 
    clearTimeout(timer);

    if (userInteracted) {
        loadingIndicator.style.display = 'none';
    } else {
        loadingIndicator.querySelector('.loading-text').textContent = "¬°Carga completa! Pulsa Comenzar para empezar y escuchar los audios.";
        // Lo ocultamos si la carga termin√≥, se mostrar√° al hacer click si es necesario
        loadingIndicator.style.display = 'none'; 
    }
});


el('playBtn').addEventListener('click', async ()=>{
  trackUserInteraction(); 
  reproducirSonidoTap();
  unlockAudio();

  if (!audiosPrecargados) {
      el('playBtn').disabled = true;
      loadingIndicator.style.display = 'flex';
      loadingIndicator.querySelector('.loading-text').textContent = "Finalizando carga...";
      await preloadWordAudios(); 
      loadingIndicator.style.display = 'none';
      el('playBtn').disabled = false;
  }

  el('startScreen').classList.remove('active');
  el('gameScreen').classList.add('active');
  placeMarkers();
  beginPlay(); 
});


playWordBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  trackUserInteraction();
  const currentWord = wordDisplay.textContent;
  // Retardo CERO al pulsar el bot√≥n de Play
  playWordAudio(currentWord, 0); 
});

el('backToMenuBtn').addEventListener('click', ()=>{
  trackUserInteraction();
  reproducirSonidoTap();
  gotoStart();
});

el('helpBtn').addEventListener('click', ()=>{
  trackUserInteraction();
  reproducirSonidoTap();
  el('helpModal').style.display='flex';
});
el('closeHelp').addEventListener('click', ()=>{
  trackUserInteraction();
  reproducirSonidoTap();
  el('helpModal').style.display='none';
});
el('helpModal').addEventListener('click', (e)=>{
  if(e.target===el('helpModal')) el('helpModal').style.display='none';
});

el('muteBtn').addEventListener('click', ()=>{
  trackUserInteraction();
  isMuted = !isMuted;
  el('muteBtn').textContent = isMuted ? 'üîá' : 'üîä';
  if (isMuted && currentWordAudio) { currentWordAudio.pause(); currentWordAudio.currentTime = 0; }
  if (pendingAudioTimeout) { clearTimeout(pendingAudioTimeout); pendingAudioTimeout = null; }
});

// Eventos para detectar la primera interacci√≥n del usuario
document.addEventListener('click', trackUserInteraction, { once: false });
document.addEventListener('touchstart', trackUserInteraction, { once: false });
document.addEventListener('keydown', trackUserInteraction, { once: false });

window.addEventListener('resize', refreshMarkersStyles);

bodyImg.addEventListener('load', ()=>{
  if(document.getElementById('gameScreen').classList.contains('active')){
    placeMarkers();
  }
});
</script>
</body>
</html>